# Nix automatically places the following paths on PATH:

NIX_ENV_PATH_ENTRIES=(
    "${HOME}/.nix-profile/bin"
    "/nix/var/nix/profiles/default/bin"
)

# Nix does this by modifying /etc/bashrc to source
# /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh, which prepends
# PATH with the aforementioned paths. Recall that /etc/bashrc is sourced by
# /etc/profile, which is automatically sourced for all login shells.
#
# Interestingly, the nix paths appear in PATH twice---once at the beginning and
# once at the end---for any login shell spawned from another login shell, e.g.,
# terminals in vscode. This happens because,
#
# - The parent shell's PATH begins with the nix paths due to nix-daemon.sh, as
#   explained above.
#
# - The spawned shell inherits PATH from the parent shell. It then sources
#   /etc/profile, which sources /usr/libexec/path_helper (see man path_helper).
#
#   - The path_helper utility is mainly responsible for building up a *new* PATH
#     from the entries in /etc/paths (/usr/local/bin, etc.) plus whatever it finds
#     in /etc/paths.d (e.g., TeX, if installed).
#
#   - It also looks at the entries in the original PATH, removes duplicates with
#     respect to the new PATH (this is why system entries like /usr/local/bin only
#     show up once), and adds the remaining original entries (e.g., the nix paths)
#     to the end of the new PATH.
#
# - Then, /etc/bashrc is sourced, followed by nix-daemon.sh, which adds the nix
#   paths to the beginning of PATH.
#
# The reason that spawning login from other spawned login shells doesn't
# produce more copies of the nix paths is because path_helper drops duplicate
# entries before appending them to PATH.
#
# I find this duplication a bit annoying, and anyway I prefer to have finer
# control over the entries in PATH. The following code removes the nix paths
# from PATH and exports them as NIX_ENV_PATH so they can later be added back to
# PATH as desired.

PATH="${PATH}:"
for ENTRY in "${NIX_ENV_PATH_ENTRIES[@]}"; do
    PATH="${PATH//${ENTRY}:}"
done
PATH="${PATH%:}"

IFS=':' read -r NIX_ENV_PATH <<<"${NIX_ENV_PATH_ENTRIES[*]}"
export NIX_ENV_PATH
